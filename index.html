<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.95, maximum-scale=0.95, user-scalable=no">
        <title>ç©ºè¿æˆæœ¬è®¡ç®—å™¨ï¼ˆåˆ†æ³¡ç‰ˆï¼‰</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }
            body {
                font-family: 'Microsoft YaHei', sans-serif;
                color: #333;
                width: 100%;
                min-height: 100vh;
                padding: 20px 15px;
                background-color: #f5f5f5;
                font-size: 16px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 12px;
                border-bottom: 2px solid #3498db;
                font-size: 20px;
                font-weight: bold;
                width: 100%;
                max-width: 600px;
            }
            .tool-buttons-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 8px;
                margin-bottom: 15px;
                width: 100%;
                max-width: 600px;
            }
            .tool-button {
                display: inline-block;
                padding: 8px 12px;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-size: 14px;
                white-space: nowrap;
                text-align: center;
                width: auto;
                flex: 0 0 auto;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            /* æ–°å¢åˆ·æ–°æ±‡ç‡æŒ‰é’®æ ·å¼ */
            .refresh-rate-btn {
                padding: 6px 10px;
                background: #27ae60;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                margin-left: 10px;
                height: 42px;
            }
            .smart-input-section {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.08);
                padding: 12px 15px;
                margin: 15px 0 20px 0;
                width: 100%;
                max-width: 600px;
            }
            .smart-input-title {
                font-weight: bold;
                color: #16a085;
                margin: 0 0 8px 0;
                font-size: 16px;
                line-height: 1;
            }
            .smart-input-box {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 15px;
                height: 40px;
                background-color: #fafafa;
                margin-bottom: 0;
            }
            .calculator {
                background-color: white;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                padding: 25px;
                margin-bottom: 25px;
                width: 100%;
                max-width: 600px;
                background-image: linear-gradient(to bottom, #ffffff 0%, #fafafa 100%);
                border: 1px solid #eee;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
                font-size: 15px;
                background-color: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            th, td {
                border: 1px solid #e0e0e0;
                padding: 10px 12px;
                text-align: left;
            }
            td:first-child {
                background-color: #f8f9fa;
                font-weight: 500;
            }
            input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 15px;
                height: 42px;
                background-color: #fafafa;
                transition: border 0.2s;
            }
            input:focus { border-color: #3498db; outline: none; }
            input::placeholder { font-size: 14px; color: #999; }
            .result {
                font-weight: bold;
                color: #2980b9;
                background-color: #e8f4fd;
                text-align: center;
                font-size: 15px;
                padding: 10px 0;
            }
            .billing-bubble-container {
                display: flex;
                gap: 15px;
                margin: 20px 0;
                width: 100%;
                flex-wrap: wrap;
            }
            .billing-section, .bubble-section {
                flex: 1;
                min-width: 200px;
            }
            .option-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin: 10px 0;
                padding: 10px;
                background-color: #f9f9f9;
                border-radius: 8px;
            }
            .option-group label {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                cursor: pointer;
                font-size: 15px;
                background-color: white;
                transition: background-color 0.2s;
            }
            .option-group label:hover { background-color: #f0f8ff; }
            .option-group input[type="radio"] {
                width: 18px;
                height: 18px;
                margin: 0;
                padding: 0;
            }
            .section-title {
                font-weight: bold;
                color: #16a085;
                margin: 15px 0 10px 0;
                font-size: 17px;
                padding-bottom: 5px;
                border-bottom: 1px solid #eee;
            }
            .hidden { display: none !important; }
            /* æ–°å¢çŠ¶æ€æç¤ºæ ·å¼ */
            .status-message {
                text-align: center;
                font-size: 14px;
                color: #7f8c8d;
                margin-top: 10px;
                min-height: 20px;
                font-style: italic;
            }
            /* æ±‡ç‡æ›´æ–°æç¤ºæ ·å¼ */
            .rate-update-tip {
                font-size: 12px;
                color: #999;
                margin-top: 5px;
                text-align: right;
            }
        </style>
    </head>
    <body>
        <h1>ç©ºè¿æˆæœ¬è®¡ç®—å™¨ï¼ˆåˆ†æ³¡ç‰ˆï¼‰</h1>

        <div class="tool-buttons-container">
            <a href="https://www.track-trace.com/" target="_blank" class="tool-button">ç‰©æµè·Ÿè¸ªæŸ¥è¯¢</a>
            <a href="https://misaka0502ab.github.io/cargodata/" target="_blank" class="tool-button">æ•°æ®è½¬æ¢å™¨</a>
            <a href="https://map.baidu.com" target="_blank" class="tool-button">ç™¾åº¦åœ°å›¾</a>
            <a href="https://www.bing.com/maps" target="_blank" class="tool-button">Bingåœ°å›¾</a>
        </div>

        <div class="smart-input-section">
            <div class="smart-input-title">æ™ºèƒ½è¯†åˆ«é‡é‡ä½“ç§¯</div>
            <input type="text" class="smart-input-box" id="smartInput" placeholder="ç¤ºä¾‹ï¼š1pcs / 250.0kgs / 0.75cbm">
        </div>

        <div class="calculator">
            <!-- çŠ¶æ€æç¤º -->
            <div class="status-message" id="statusMessage">è¯·å¡«å†™åŸºç¡€å‚æ•°ï¼Œç»“æœå°†è‡ªåŠ¨è®¡ç®—</div>

            <div class="section-title">åŸºç¡€å‚æ•°</div>
            <table>
                <tr>
                    <td>ä½“ç§¯ (mÂ³)</td>
                    <td><input type="number" id="volume" step="0.01" placeholder="è¾“å…¥ä½“ç§¯"></td>
                    <td>C.W.</td>
                    <td class="result" id="cw">-</td>
                </tr>
                <tr>
                    <td>G.W. (kg)</td>
                    <td><input type="number" id="gw" step="0.01" placeholder="è¾“å…¥å®é™…é‡é‡"></td>
                    <td>æ¯”ä¾‹</td>
                    <td class="result" id="ratio">-</td>
                </tr>
                <tr>
                    <td>USD/RMBæ±‡ç‡</td>
                    <td>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="exchangeRate" step="0.01" value="6.93">
                            <button class="refresh-rate-btn" id="refreshRateBtn">åˆ·æ–°æ±‡ç‡</button>
                        </div>
                        <div class="rate-update-tip" id="rateUpdateTip">æ±‡ç‡åŒæ­¥è‡ªï¼šç®—æ±‡ç½‘æ‹›è¡Œç°æ±‡ä¹°å…¥ä»·</div>
                    </td>
                    <td>æˆæœ¬è®¡è´¹é‡</td>
                    <td class="result" id="costWeight">-</td>
                </tr>
            </table>

            <div class="section-title">æˆæœ¬è®¡ç®—</div>
            <table>
                <tr>
                    <td>æˆæœ¬RMB/KG</td>
                    <td><input type="number" id="rmbPerKg" step="0.01" placeholder="è¾“å…¥RMBå•ä»·"></td>
                    <td>åˆ†æ³¡åRMB/KG</td>
                    <td class="result" id="rmbAfter">-</td>
                </tr>
                <tr>
                    <td>æˆæœ¬USD/KG</td>
                    <td class="result" id="usdPerKg">-</td>
                    <td>åˆ†æ³¡åUSD/KG</td>
                    <td class="result" id="usdAfter">-</td>
                </tr>
            </table>

            <div class="section-title">æ€»æˆæœ¬</div>
            <table>
                <tr>
                    <td colspan="2"></td>
                    <td>ç©ºè¿æ€»æˆæœ¬RMB</td>
                    <td class="result" id="totalRMB">-</td>
                </tr>
                <tr>
                    <td colspan="2"></td>
                    <td>ç©ºè¿æ€»æˆæœ¬USD</td>
                    <td class="result" id="totalUSD">-</td>
                </tr>
            </table>

            <div class="billing-bubble-container">
                <div class="billing-section">
                    <div class="section-title">è®¡è´¹æ ‡å‡†</div>
                    <div class="option-group">
                        <label><input type="radio" name="billing" value="0.006" checked><span>å¤§é™† (167)</span></label>
                        <label><input type="radio" name="billing" value="0.007"><span>é¦™æ¸¯ (143)</span></label>
                    </div>
                </div>
                <div class="bubble-section">
                    <div class="section-title">åˆ†æ³¡æ¯”ä¾‹</div>
                    <div class="option-group" id="mainlandBubble">
                        <label><input type="radio" name="bubble" value="0.5" checked><span>55åˆ†</span></label>
                        <label><input type="radio" name="bubble" value="0.4"><span>46åˆ†</span></label>
                        <label><input type="radio" name="bubble" value="0.3"><span>37åˆ†</span></label>
                        <label><input type="radio" name="bubble" value="0.2"><span>28åˆ†</span></label>
                    </div>
                    <div class="option-group hidden" id="hongkongBubble">
                        <label><input type="radio" name="bubbleHk" value="0.3333" checked><span>1/3</span></label>
                        <label><input type="radio" name="bubbleHk" value="0.6667"><span>2/3</span></label>
                    </div>
                </div>
            </div>
            <!-- åŸè®¡ç®—æŒ‰é’®å·²ç§»é™¤ -->
        </div>

        <script>
            // è·å–è¾“å…¥å…ƒç´ å’ŒçŠ¶æ€æç¤ºå…ƒç´ 
            const volumeInput = document.getElementById('volume');
            const gwInput = document.getElementById('gw');
            const exchangeRateInput = document.getElementById('exchangeRate');
            const rmbPerKgInput = document.getElementById('rmbPerKg');
            const smartInput = document.getElementById('smartInput');
            const statusMessage = document.getElementById('statusMessage');
            const refreshRateBtn = document.getElementById('refreshRateBtn');
            const rateUpdateTip = document.getElementById('rateUpdateTip');

            // è‡ªåŠ¨è¯†åˆ«å‡½æ•°
            function autoParseSmartInput() {
                try {
                    const inputText = smartInput.value.trim();
                    if (!inputText) return;

                    // æ­£åˆ™æå–é‡é‡
                    const weightRegex = /(\d+\.?\d*)\s*(?:kgs?|åƒå…‹|å…¬æ–¤)/i;
                    const weightMatch = inputText.match(weightRegex);
                    const weight = weightMatch ? parseFloat(weightMatch[1]) : null;

                    // æ­£åˆ™æå–ä½“ç§¯
                    const volumeRegex = /(\d+\.?\d*)\s*(?:cbm|ç«‹æ–¹ç±³|mÂ³|m3)/i;
                    const volumeMatch = inputText.match(volumeRegex);
                    const volume = volumeMatch ? parseFloat(volumeMatch[1]) : null;

                    // å¡«å……åˆ°å¯¹åº”è¾“å…¥æ¡†
                    if (weight) {
                        gwInput.value = weight.toFixed(3);
                        statusMessage.textContent = `âœ… å·²è¯†åˆ«é‡é‡: ${weight}kgs`;
                    }
                    if (volume) {
                        volumeInput.value = volume.toFixed(3);
                        statusMessage.textContent += volume ? ` ä½“ç§¯: ${volume}cbm` : '';
                    }

                    // è¯†åˆ«åç«‹å³è§¦å‘è‡ªåŠ¨è®¡ç®—
                    setTimeout(calculate, 100);

                } catch (e) {
                    console.log("è‡ªåŠ¨è¯†åˆ«å¤±è´¥ï¼š" + e.message);
                }
            }

            // æ ¸å¿ƒè®¡ç®—é€»è¾‘
            function calculate() {
                try {
                    const volume = parseFloat(volumeInput.value) || 0;
                    const gw = parseFloat(gwInput.value) || 0;
                    const exchangeRate = parseFloat(exchangeRateInput.value) || 6.93;
                    const rmbPerKg = parseFloat(rmbPerKgInput.value) || 0;

                    // è·å–è®¡è´¹æ ‡å‡†å’Œåˆ†æ³¡æ¯”ä¾‹
                    const billing = parseFloat(document.querySelector('input[name="billing"]:checked').value) || 0.006;
                    let bubble = 0;
                    if (billing === 0.006) {
                        bubble = parseFloat(document.querySelector('input[name="bubble"]:checked').value) || 0.5;
                    } else {
                        bubble = parseFloat(document.querySelector('input[name="bubbleHk"]:checked').value) || 0.3333;
                    }

                    // åŸºç¡€éªŒè¯
                    const hasBasicInput = volume > 0 && gw > 0;
                    const hasPrice = rmbPerKg > 0;

                    // æ›´æ–°çŠ¶æ€æç¤º
                    if (!hasBasicInput) {
                        statusMessage.textContent = 'è¯·å¡«å†™ä½“ç§¯å’Œå®é™…é‡é‡';
                        return;
                    }
                    if (!hasPrice) {
                        statusMessage.textContent = 'å·²è®¡ç®—åŸºç¡€å‚æ•°ï¼Œè¯·è¾“å…¥RMBå•ä»·å®Œæˆæˆæœ¬è®¡ç®—';
                    } else {
                        statusMessage.textContent = 'âœ… è®¡ç®—å®Œæˆï¼ˆæ‰€æœ‰æ•°æ®å®æ—¶æ›´æ–°ï¼‰';
                    }

                    // è®¡ç®—å¹¶æ˜¾ç¤ºåŸºç¡€ç»“æœ
                    const cw = volume / billing;
                    document.getElementById('cw').textContent = hasBasicInput ? cw.toFixed(2) : '-';

                    const ratio = volume > 0 ? gw / volume : 0;
                    document.getElementById('ratio').textContent = hasBasicInput ? ratio.toFixed(4) : '-';

                    const costWeight = gw + (cw - gw) * bubble;
                    document.getElementById('costWeight').textContent = hasBasicInput ? costWeight.toFixed(2) : '-';

                    // è®¡ç®—å¹¶æ˜¾ç¤ºæˆæœ¬ç»“æœ
                    const costUsdPerKg = exchangeRate > 0 ? rmbPerKg / exchangeRate : 0;
                    document.getElementById('usdPerKg').textContent = hasPrice ? costUsdPerKg.toFixed(4) : '-';

                    const totalRMB = costWeight * rmbPerKg;
                    const totalUSD = costWeight * costUsdPerKg;
                    document.getElementById('totalRMB').textContent = hasPrice ? totalRMB.toFixed(2) : '-';
                    document.getElementById('totalUSD').textContent = hasPrice ? totalUSD.toFixed(2) : '-';

                    const rmbAfter = cw > 0 ? totalRMB / cw : 0;
                    document.getElementById('rmbAfter').textContent = (hasBasicInput && hasPrice) ? rmbAfter.toFixed(4) : '-';

                    const usdAfter = cw > 0 ? totalUSD / cw : 0;
                    document.getElementById('usdAfter').textContent = (hasBasicInput && hasPrice) ? usdAfter.toFixed(4) : '-';

                } catch (e) {
                    statusMessage.textContent = 'è®¡ç®—å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥';
                    console.error("è®¡ç®—é”™è¯¯: ", e);
                }
            }

            // æ–°å¢ï¼šæŠ“å–ç®—æ±‡ç½‘æ±‡ç‡å¹¶æ›´æ–°
            async function fetchExchangeRate() {
                try {
                    statusMessage.textContent = 'ğŸ”„ æ­£åœ¨åŒæ­¥æœ€æ–°æ±‡ç‡...';
                    refreshRateBtn.disabled = true;
                    refreshRateBtn.textContent = 'åŒæ­¥ä¸­...';

                    // æŠ“å–ç®—æ±‡ç½‘é¡µé¢ï¼ˆä½¿ç”¨CORSä»£ç†è§£å†³è·¨åŸŸé—®é¢˜ï¼‰
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.suanhui.com/zhaohang/');
                    const response = await fetch(proxyUrl);
                    const data = await response.json();
                    const htmlContent = data.contents;

                    // æ­£åˆ™æå–æ‹›è¡Œç¾å…ƒç°æ±‡ä¹°å…¥ä»·ï¼ˆåŒ¹é…ï¼šç°æ±‡ä¹°å…¥<span>689.82</span>ï¼‰
                    const rateRegex = /ç°æ±‡ä¹°å…¥<\/td>\s*<td[^>]*>(\d+\.?\d*)<\/td>/i;
                    const rateMatch = htmlContent.match(rateRegex);

                    if (rateMatch && rateMatch[1]) {
                        // è½¬æ¢ä¸ºæ±‡ç‡ï¼ˆ689.82 â†’ 6.8982ï¼Œä¿ç•™ä¸¤ä½å°æ•°ï¼‰
                        const rawRate = parseFloat(rateMatch[1]);
                        const exchangeRate = (rawRate / 100).toFixed(2);
                        exchangeRateInput.value = exchangeRate;

                        // æ›´æ–°æç¤º
                        rateUpdateTip.textContent = `æœ€æ–°åŒæ­¥ï¼šæ‹›è¡Œç°æ±‡ä¹°å…¥ä»· ${rawRate} â†’ æ±‡ç‡ ${exchangeRate}ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰`;
                        statusMessage.textContent = 'âœ… æ±‡ç‡å·²åŒæ­¥æœ€æ–°å€¼ï¼';
                        
                        // åŒæ­¥åè‡ªåŠ¨è®¡ç®—
                        calculate();
                    } else {
                        throw new Error('æœªæ‰¾åˆ°ç°æ±‡ä¹°å…¥ä»·');
                    }

                } catch (e) {
                    console.error("æ±‡ç‡æŠ“å–å¤±è´¥: ", e);
                    statusMessage.textContent = 'âš ï¸ æ±‡ç‡åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼6.93';
                    rateUpdateTip.textContent = 'åŒæ­¥å¤±è´¥ï¼šç½‘ç»œé—®é¢˜æˆ–é¡µé¢ç»“æ„å˜æ›´';
                    exchangeRateInput.value = '6.93'; // å›é€€åˆ°é»˜è®¤å€¼
                } finally {
                    refreshRateBtn.disabled = false;
                    refreshRateBtn.textContent = 'åˆ·æ–°æ±‡ç‡';
                }
            }

            // é¡µé¢åŠ è½½å®Œæˆåçš„äº‹ä»¶ç»‘å®š
            document.addEventListener('DOMContentLoaded', function() {
                // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŒæ­¥æ±‡ç‡
                fetchExchangeRate();

                // è®¡è´¹æ ‡å‡†åˆ‡æ¢é€»è¾‘
                const billingRadios = document.querySelectorAll('input[name="billing"]');
                billingRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const isMainland = this.value === "0.006";
                        document.getElementById('mainlandBubble').classList.toggle('hidden', !isMainland);
                        document.getElementById('hongkongBubble').classList.toggle('hidden', isMainland);
                        calculate(); // åˆ‡æ¢åè‡ªåŠ¨è®¡ç®—
                    });
                });

                // åˆ†æ³¡æ¯”ä¾‹åˆ‡æ¢é€»è¾‘
                document.querySelectorAll('input[name="bubble"], input[name="bubbleHk"]').forEach(radio => {
                    radio.addEventListener('change', calculate);
                });

                // æ™ºèƒ½è¾“å…¥æ¡†äº‹ä»¶
                smartInput.addEventListener('input', autoParseSmartInput);
                smartInput.addEventListener('blur', autoParseSmartInput);

                // ä¸ºæ‰€æœ‰å…³é”®è¾“å…¥æ¡†ç»‘å®šè¾“å…¥äº‹ä»¶ï¼ˆè‡ªåŠ¨è®¡ç®—çš„æ ¸å¿ƒï¼‰
                const autoCalcInputs = [volumeInput, gwInput, exchangeRateInput, rmbPerKgInput];
                autoCalcInputs.forEach(input => {
                    input.addEventListener('input', calculate);
                    input.addEventListener('blur', calculate);
                });

                // ç»‘å®šåˆ·æ–°æ±‡ç‡æŒ‰é’®äº‹ä»¶
                refreshRateBtn.addEventListener('click', fetchExchangeRate);

                // åˆå§‹åŒ–çŠ¶æ€
                calculate();
            });
        </script>
    </body>
</html>
